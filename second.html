<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Калькулятор</title>
    <style>
        :root{--bg:#0f1724;--panel:#0b1220;--accent:#60a5fa;--btn:#0f1728;--btn-hover:#162133;--text:#e6eef8}
        *{box-sizing:border-box}
        body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071426 0%, #061627 100%);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
        .calculator{width:360px;max-width:94vw;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));border-radius:14px;padding:20px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
        .screen{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));padding:14px;border-radius:10px;min-height:76px;display:flex;flex-direction:column;justify-content:center;align-items:flex-end}
        .expression{font-size:14px;opacity:0.7;word-break:break-all}
        .result{font-size:28px;font-weight:600;margin-top:6px}
        .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:16px}
        button.key{background:var(--btn);color:var(--text);border:0;padding:14px;border-radius:10px;font-size:18px;cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,0.25);transition:transform .08s ease,background .12s}
        button.key:active{transform:translateY(2px)}
        button.key.operator{background:linear-gradient(90deg,var(--accent),#4c8feb);font-weight:600}
        button.key.span-two{grid-column:span 2}
        .muted{opacity:0.8;font-size:15px}
        .small{font-size:14px}
        .footer{margin-top:12px;text-align:center;opacity:0.7;font-size:13px}
        @media (max-width:420px){.calculator{padding:14px}.result{font-size:24px}.screen{min-height:64px}}
    </style>
</head>
<body>
<main class="calculator" role="application" aria-label="Калькулятор">
    <div class="screen" id="screen">
        <div id="expression" class="expression" aria-live="polite"></div>
        <div id="result" class="result" aria-live="polite">0</div>
    </div>

    <div class="keys" role="grid">
        <button class="key muted" data-action="clear" title="Очистить">AC</button>
        <button class="key muted" data-action="back" title="Удалить">DEL</button>
        <button class="key muted" data-value="%">%</button>
        <button class="key operator" data-value="/">÷</button>

        <button class="key" data-value="7">7</button>
        <button class="key" data-value="8">8</button>
        <button class="key" data-value="9">9</button>
        <button class="key operator" data-value="*">×</button>

        <button class="key" data-value="4">4</button>
        <button class="key" data-value="5">5</button>
        <button class="key" data-value="6">6</button>
        <button class="key operator" data-value="-">−</button>

        <button class="key" data-value="1">1</button>
        <button class="key" data-value="2">2</button>
        <button class="key" data-value="3">3</button>
        <button class="key operator" data-value="+">+</button>

        <button class="key" data-value="0">0</button>
        <button class="key" data-value=",">,</button>
        <button class="key" data-value="(" title="Скобка">(</button>
        <button class="key" data-value=")" title="Скобка">)</button>

        <button class="key span-two" data-action="evaluate" style="background:linear-gradient(90deg,#10b981,#06b6d4);font-weight:700">=</button>
    </div>

    <div class="footer">Поддерживаются клавиатура: цифры, + - * / ( ) . , Enter =, Backspace</div>
</main>

<script>
    (function(){
        const exprEl = document.getElementById('expression');
        const resEl = document.getElementById('result');
        let expression = '';

        function updateScreen(){
            exprEl.textContent = expression || '';
            resEl.textContent = expression ? safeEvalPreview(expression) : '0';
        }

        function append(value){
            // normalize comma to dot
            if(value === ',') value = '.';
            expression += value;
            updateScreen();
        }

        function clearAll(){ expression = ''; updateScreen(); }
        function backspace(){ expression = expression.slice(0,-1); updateScreen(); }

        function percentTransform(src){
            // Replace occurrences like 12% or 12.5% with (12/100)
            return src.replace(/(\d+(?:\.\d+)?)%/g, '($1/100)');
        }

        function isSafe(src){
            // allow digits, operators, parentheses, dot, spaces
            return /^[0-9+\-*/().\s%]+$/.test(src);
        }

        function safeEvalPreview(src){
            try{
                const transformed = percentTransform(src);
                if(!isSafe(transformed)) return '';
                // try lightweight evaluation for preview; if fails, return empty
                const val = Function('return '+transformed)();
                if(val === undefined) return '';
                // format small floats
                return Number.isFinite(val) ? +parseFloat(val.toFixed(10)) : '';
            }catch(e){return ''}
        }

        function evaluateExpression(){
            if(!expression) return;
            const transformed = percentTransform(expression);
            if(!isSafe(transformed)){
                resEl.textContent = 'Ошибка';
                return;
            }
            try{
                let value = Function('return '+transformed)();
                if(typeof value === 'number' && isFinite(value)){
                    // trim unnecessary zeros
                    value = +parseFloat(value.toFixed(10));
                    expression = String(value);
                    updateScreen();
                }else{
                    resEl.textContent = 'Ошибка';
                }
            }catch(e){ resEl.textContent = 'Ошибка' }
        }

        // click handling
        document.querySelectorAll('button.key').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                const v = btn.getAttribute('data-value');
                const a = btn.getAttribute('data-action');
                if(a === 'clear') return clearAll();
                if(a === 'back') return backspace();
                if(a === 'evaluate') return evaluateExpression();
                if(v) append(v);
            });
        });

        // keyboard handling
        window.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter' || e.key === '='){ e.preventDefault(); evaluateExpression(); return; }
            if(e.key === 'Backspace'){ e.preventDefault(); backspace(); return; }
            if(e.key === 'Escape'){ clearAll(); return; }
            const allowed = '0123456789+-*/().,%,';
            if(e.key === ',') { append(','); return; }
            if(allowed.includes(e.key)){
                e.preventDefault(); append(e.key);
            }
        });

        // initialize
        updateScreen();
    })();
</script>

<button class="key"><a href="/" style="text-decoration: none;color: white">Go Back</a></button>
</body>
</html>